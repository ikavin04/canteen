<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Canteen - Payment</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">Smart Canteen</h1>
            <div class="nav-menu">
                <div class="user-info">
                    <span id="userName">User</span>
                    <button onclick="logout()" class="btn btn-small">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="payment-container">
            <div class="payment-card">
                <h2>Payment</h2>
                <div id="message" class="message hidden"></div>
                
                
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="order-items" id="orderItems">
                        
                    </div>
                    <div class="order-total">
                        <strong>Total Amount: ₹<span id="totalAmount">0.00</span></strong>
                    </div>
                </div>
                
                
                <div class="payment-methods">
                    <h3>Select Payment Method</h3>
                    <div class="payment-option">
                        <input type="radio" id="upi" name="paymentMethod" value="UPI" checked>
                        <label for="upi">UPI Payment (Demo)</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" id="card" name="paymentMethod" value="Card">
                        <label for="card">Credit/Debit Card (Demo)</label>
                    </div>
                </div>
                
                
                <div id="paymentDetails" class="payment-details">
                    <div id="upiDetails" class="payment-form">
                        <div class="form-group">
                            <label for="upiId">UPI ID</label>
                            <input type="text" id="upiId" placeholder="yourname@upi">
                        </div>
                    </div>
                    
                    <div id="cardDetails" class="payment-form hidden">
                        <div class="form-group">
                            <label for="cardNumber">Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expiryDate">Expiry Date</label>
                                <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" placeholder="123" maxlength="3">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-actions">
                    <button onclick="goBack()" class="btn btn-secondary">Back to Cart</button>
                    <button onclick="processPayment()" class="btn btn-primary" id="payButton">
                        Pay ₹<span id="payAmount">0.00</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        // Check authentication
        const currentUser = getCurrentUser();
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role === 'admin') {
            window.location.href = 'admin.html';
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userName').textContent = currentUser.username;
            loadOrderSummary();
            setupPaymentMethodHandlers();
        });
        
        function loadOrderSummary() {
            const cart = getCart();
            
            if (cart.length === 0) {
                showMessage('Your cart is empty. Redirecting to menu...', 'error');
                setTimeout(() => {
                    window.location.href = 'user_dashboard.html';
                }, 2000);
                return;
            }
            
            const orderItems = document.getElementById('orderItems');
            const totalAmount = document.getElementById('totalAmount');
            const payAmount = document.getElementById('payAmount');
            
            // Display order items
            orderItems.innerHTML = cart.map(item => `
                <div class="order-item">
                    <div class="item-details">
                        <h4>${item.name}</h4>
                        <p>₹${item.price.toFixed(2)} × ${item.quantity}</p>
                    </div>
                    <div class="item-total">
                        ₹${(item.price * item.quantity).toFixed(2)}
                    </div>
                </div>
            `).join('');
            
            // Calculate and display total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalAmount.textContent = total.toFixed(2);
            payAmount.textContent = total.toFixed(2);
        }
        
        function setupPaymentMethodHandlers() {
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            const upiDetails = document.getElementById('upiDetails');
            const cardDetails = document.getElementById('cardDetails');
            const paymentDetails = document.getElementById('paymentDetails');
            
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    if (this.value === 'UPI') {
                        paymentDetails.classList.remove('hidden');
                        upiDetails.classList.remove('hidden');
                        cardDetails.classList.add('hidden');
                    } else if (this.value === 'Card') {
                        paymentDetails.classList.remove('hidden');
                        upiDetails.classList.add('hidden');
                        cardDetails.classList.remove('hidden');
                    } else {
                        paymentDetails.classList.add('hidden');
                    }
                });
            });
        }
        
        function processPayment() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const cart = getCart();
            
            if (cart.length === 0) {
                showMessage('Your cart is empty', 'error');
                return;
            }
            
            // Validate payment details based on method
            if (paymentMethod === 'UPI') {
                const upiId = document.getElementById('upiId').value.trim();
                if (!upiId) {
                    showMessage('Please enter your UPI ID', 'error');
                    return;
                }
                if (!upiId.includes('@')) {
                    showMessage('Please enter a valid UPI ID', 'error');
                    return;
                }
            } else if (paymentMethod === 'Card') {
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const expiryDate = document.getElementById('expiryDate').value;
                const cvv = document.getElementById('cvv').value;
                
                if (!cardNumber || cardNumber.length < 16) {
                    showMessage('Please enter a valid card number', 'error');
                    return;
                }
                if (!expiryDate || !expiryDate.match(/^\d{2}\/\d{2}$/)) {
                    showMessage('Please enter expiry date in MM/YY format', 'error');
                    return;
                }
                if (!cvv || cvv.length < 3) {
                    showMessage('Please enter a valid CVV', 'error');
                    return;
                }
            }
            
            showMessage('Processing payment...', 'info');

            // Try server-side checkout if backend available, otherwise fallback to local simulation
            const currentUser = getCurrentUser();
            const payload = {
                user_id: currentUser ? currentUser.id : null,
                cart: cart,
                payment_method: paymentMethod
            };

            fetch('/api/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(res => {
                if (!res.ok) throw new Error('Payment failed');
                return res.json();
            }).then(data => {
                if (data && data.success) {
                    showMessage('Payment successful! Order placed.', 'success');
                    clearCart();
                    setTimeout(() => {
                        window.location.href = `order_confirmation.html?orderId=${data.orderId || data.order_id || ''}`;
                    }, 1200);
                } else {
                    showMessage(data.message || 'Payment failed', 'error');
                }
            }).catch(error => {
                showMessage(error.message || 'Payment failed', 'error');
            });
        }
        
        function goBack() {
            window.location.href = 'user_dashboard.html';
        }
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }
        
        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function() {
            let value = this.value.replace(/\s/g, '');
            let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
            if (formattedValue !== this.value) {
                this.value = formattedValue;
            }
        });
        
        // Format expiry date input
        document.getElementById('expiryDate').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            this.value = value;
        });
        
        // Only allow numbers in CVV
        document.getElementById('cvv').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    </script>
</body>
</html>
