<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Canteen - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">Smart Canteen Admin</h1>
            <div class="nav-menu">
                <div class="user-info">
                    <span id="adminName">Welcome, Admin</span>
                    <button onclick="logout()" class="btn btn-small">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div id="notification" class="notification hidden"></div>
        
        <div class="admin-tabs">
            <button class="tab-button active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="showTab('menu')">Menu Management</button>
            <button class="tab-button" onclick="showTab('orders')">Order Management</button>
        </div>

        
        <div id="dashboard" class="tab-content active">
            
            <div class="dashboard-recent">
                <div class="recent-orders">
                    <h3>Recent Orders</h3>
                    <div class="recent-orders-list" id="recentOrdersList">
                        
                    </div>
                </div>
                
                <div class="quick-stats">
                    <h3>Quick Stats</h3>
                    <div class="quick-stat-item">
                        <span>Available Menu Items:</span>
                        <span id="availableItems">0</span>
                    </div>
                    <div class="quick-stat-item">
                        <span>Unavailable Menu Items:</span>
                        <span id="unavailableItems">0</span>
                    </div>
                    <div class="quick-stat-item">
                        <span>Orders Today:</span>
                        <span id="ordersToday">0</span>
                    </div>
                    <div class="quick-stat-item">
                        <span>Revenue Today:</span>
                        <span>₹<span id="revenueToday">0.00</span></span>
                    </div>
                </div>
                
                <!-- Order ID Verification Section -->
                <div class="verification-section">
                    <h3>Verify Order for Pickup</h3>
                    <div class="verify-container">
                        <div class="form-group">
                            <label for="verifyOrderId">Enter Order ID</label>
                            <input type="text" id="verifyOrderId" placeholder="ORD-XXXXXX" style="text-transform: uppercase; font-size: 1.1rem; padding: 14px 16px; border-radius: 20px;">
                        </div>
                        <button onclick="verifyOrder()" class="btn btn-primary">Verify Order</button>
                    </div>
                    <div id="verificationResult" class="verification-result hidden"></div>
                </div>
            </div>
        </div>

        
        <div id="menu" class="tab-content">
            <div class="menu-management">
                <div class="menu-header">
                    <h2>Menu Management</h2>
                    <button onclick="showAddItemForm()" class="btn btn-primary">Add New Item</button>
                </div>
                
                
                <div id="itemFormContainer" class="form-container hidden">
                    <div class="form-card">
                        <h3 id="formTitle">Add New Menu Item</h3>
                        <form id="menuItemForm">
                            <input type="hidden" id="editItemId">
                            
                            <div class="form-group">
                                <label for="itemName">Item Name</label>
                                <input type="text" id="itemName" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="itemPrice">Price (₹)</label>
                                    <input type="number" id="itemPrice" step="0.01" min="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="itemCategory">Category</label>
                                    <select id="itemCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="Main Course">Main Course</option>
                                        <option value="Snacks">Snacks</option>
                                        <option value="Beverages">Beverages</option>
                                        <option value="Breakfast">Breakfast</option>
                                        <option value="Desserts">Desserts</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" onclick="cancelItemForm()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Item</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menuTableBody">
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        
        <div id="orders" class="tab-content">
            <div class="order-management">
                <div class="admin-section-header">
                    <h2>Order Management</h2>
                    <div class="admin-controls">
                        <div class="filter-group">
                            <label for="orderStatusFilter">Filter by Status:</label>
                            <select id="orderStatusFilter" onchange="filterOrders()" class="admin-select">
                                <option value="">All Orders</option>
                                <option value="Uncompleted">Preparing</option>
                                <option value="Ready">Ready for Pickup</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-group">
                            <label for="orderSearchInput">Search Orders:</label>
                            <input type="text" id="orderSearchInput" class="admin-search" placeholder="Enter Order ID or Customer Name" oninput="filterOrders()">
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </main>

    
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order Details</h3>
                <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check authentication
        const currentUser = getCurrentUser();
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role !== 'admin') {
            window.location.href = 'user_dashboard.html';
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminName').textContent = `Welcome, ${currentUser.username}`;
            loadDashboardStats();
            loadMenuItems();
            loadOrders();
            startNotificationPolling();
        });
        
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load specific data based on tab
            if (tabName === 'dashboard') {
                loadDashboardStats();
            } else if (tabName === 'menu') {
                loadMenuItems();
            } else if (tabName === 'orders') {
                loadOrders();
            }
        }
        
        async function loadDashboardStats() {
            const users = await getAllUsers();
            const orders = await getAllOrders();
            const menu = await getMenu();
            
            // Calculate stats
            const totalUsers = users.filter(user => user.role === 'user').length;
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + order.total_amount, 0);
            const pendingOrders = orders.filter(order => order.status === 'Uncompleted').length;
            
            const today = new Date().toDateString();
            const ordersToday = orders.filter(order => new Date(order.created_at || order.timestamp).toDateString() === today);
            const revenueToday = ordersToday.reduce((sum, order) => sum + order.total_amount, 0);
            
            const availableItems = menu.filter(item => item.availability).length;
            const unavailableItems = menu.filter(item => !item.availability).length;
            
            // Update UI - only update elements that exist
            document.getElementById('ordersToday').textContent = ordersToday.length;
            document.getElementById('revenueToday').textContent = parseFloat(revenueToday).toFixed(2);
            document.getElementById('availableItems').textContent = availableItems;
            document.getElementById('unavailableItems').textContent = unavailableItems;
            
            // Load recent orders
            const recentOrders = orders.slice(0, 5).sort((a, b) => new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp));
            const recentOrdersList = document.getElementById('recentOrdersList');
            
            recentOrdersList.innerHTML = recentOrders.map(order => {
                const orderDate = new Date(order.created_at || order.timestamp);
                const formattedDate = orderDate.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const formattedTime = orderDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                return `
                    <div class="recent-order-item">
                        <div class="order-info">
                            <div class="order-id-text">${order.order_id}</div>
                            <div class="order-datetime">${formattedDate}, ${formattedTime}</div>
                        </div>
                        <div class="order-user-type">
                            <span class="user-type-badge">${order.user_type || 'Student'}</span>
                        </div>
                        <div class="order-status-col">
                            <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadMenuItems() {
            const menu = await getMenu();
            const menuTableBody = document.getElementById('menuTableBody');
            
            menuTableBody.innerHTML = menu.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.item_name}</td>
                    <td>${item.category}</td>
                    <td>₹${parseFloat(item.price).toFixed(2)}</td>
                    <td>
                        <span class="availability-badge ${item.availability ? 'available' : 'unavailable'}">
                            ${item.availability ? 'Available' : 'Unavailable'}
                        </span>
                    </td>
                    <td>
                        <button onclick="editMenuItem(${item.id})" class="btn btn-small">Edit</button>
                        <button onclick="toggleAvailability(${item.id})" class="btn btn-small btn-secondary">
                            ${item.availability ? 'Disable' : 'Enable'}
                        </button>
                        <button onclick="deleteMenuItem(${item.id})" class="btn btn-small btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadOrders() {
            try {
                const orders = await getAllOrders();
                const statusFilter = document.getElementById('orderStatusFilter').value;
                const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
                
                let filteredOrders = orders;
                
                if (statusFilter) {
                    filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
                }
                
                if (searchTerm) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.order_id.toLowerCase().includes(searchTerm) ||
                        (order.username || '').toLowerCase().includes(searchTerm)
                    );
                }
                
                const ordersTableBody = document.getElementById('ordersTableBody');
                
                ordersTableBody.innerHTML = filteredOrders.map(order => {
                    return `
                    <tr>
                        <td>${order.order_id}</td>
                        <td>${order.username || 'Unknown'}</td>
                        <td>${order.items.length} items</td>
                        <td>₹${parseFloat(order.total_amount).toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order.order_id}', this.value)" class="status-select" value="${order.status}" style="background: ${getStatusColor(order.status).bg}; color: ${getStatusColor(order.status).text}; border-color: ${getStatusColor(order.status).border};">
                                <option value="Uncompleted" ${order.status === 'Uncompleted' ? 'selected' : ''}>Preparing</option>
                                <option value="Ready" ${order.status === 'Ready' ? 'selected' : ''}>Ready</option>
                                <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </td>
                        <td>${new Date(order.created_at || order.timestamp).toLocaleString()}</td>
                        <td>
                            <button onclick="viewOrderDetails('${order.order_id}')" class="btn btn-small">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
                const ordersTableBody = document.getElementById('ordersTableBody');
                ordersTableBody.innerHTML = '<tr><td colspan="6">Error loading orders</td></tr>';
            }
        }
        
        function getStatusColor(status) {
            const colors = {
                'Uncompleted': { bg: '#fff3cd', text: '#856404', border: '#ffc107' },
                'Ready': { bg: '#d1ecf1', text: '#0c5460', border: '#17a2b8' },
                'Completed': { bg: '#d4edda', text: '#155724', border: '#28a745' }
            };
            return colors[status] || colors['Uncompleted'];
        }
        
        function filterOrders() {
            loadOrders();
        }
        
        function showAddItemForm() {
            document.getElementById('formTitle').textContent = 'Add New Menu Item';
            document.getElementById('editItemId').value = '';
            document.getElementById('menuItemForm').reset();
            document.getElementById('itemFormContainer').classList.remove('hidden');
        }
        
        function cancelItemForm() {
            document.getElementById('itemFormContainer').classList.add('hidden');
        }
        
        async function editMenuItem(itemId) {
            const menu = await getMenu();
            const item = menu.find(i => i.id === itemId);
            
            if (!item) return;
            
            document.getElementById('formTitle').textContent = 'Edit Menu Item';
            document.getElementById('editItemId').value = itemId;
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemFormContainer').classList.remove('hidden');
        }
        
        async function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                const result = await deleteMenuItemById(itemId);
                if (result.success) {
                    showNotification('Menu item deleted successfully', 'success');
                    loadMenuItems();
                    loadDashboardStats();
                } else {
                    showNotification(result.message, 'error');
                }
            }
        }
        
        async function toggleAvailability(itemId) {
            const result = await toggleMenuItemAvailability(itemId);
            if (result.success) {
                showNotification('Availability updated successfully', 'success');
                loadMenuItems();
                loadDashboardStats();
            } else {
                showNotification(result.message, 'error');
            }
        }
        
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (result.success) {
                    showNotification(`Order ${orderId} status updated to ${newStatus}`, 'success');
                    loadOrders();
                    loadDashboardStats();
                } else {
                    throw new Error(result.message || 'Failed to update status');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Failed to update order status', 'error');
            }
        }
        
        async function viewOrderDetails(orderId) {
            try {
                const orders = await getAllOrders();
                const order = orders.find(o => o.order_id === orderId);
                
                if (!order) {
                    showNotification('Order not found', 'error');
                    return;
                }
            
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="order-detail-info">
                    <div class="detail-row">
                        <span class="label">Order ID:</span>
                        <span class="value">${order.order_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Customer:</span>
                        <span class="value">${order.username || 'Unknown'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Email:</span>
                        <span class="value">N/A</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Order Time:</span>
                        <span class="value">${new Date(order.created_at || order.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Payment Method:</span>
                        <span class="value">${order.payment_method}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Transaction ID:</span>
                        <span class="value">${order.transaction_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Status:</span>
                        <span class="value status-${order.status.toLowerCase()}">${order.status}</span>
                    </div>
                </div>
                
                <div class="order-items-detail">
                    <h4>Items Ordered:</h4>
                    <div class="items-list">
                        ${order.items.map(item => `
                            <div class="item-detail">
                                <div class="item-info">
                                    <h5>${item.name}</h5>
                                    <p>₹${parseFloat(item.price).toFixed(2)} × ${item.quantity}</p>
                                </div>
                                <div class="item-total">
                                    ₹${(parseFloat(item.price) * item.quantity).toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-total-detail">
                        <strong>Total: ₹${parseFloat(order.total_amount).toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('orderDetailsModal').style.display = 'block';
            } catch (error) {
                console.error('Error viewing order details:', error);
                showNotification('Error loading order details', 'error');
            }
        }
        
        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').style.display = 'none';
        }
        

        

        
        function startNotificationPolling() {
            // Check for new orders every 30 seconds
            setInterval(async () => {
                const orders = await getAllOrders();
                const recentOrders = orders.filter(order => {
                    const orderTime = new Date(order.timestamp);
                    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                    return orderTime > fiveMinutesAgo && order.status === 'Uncompleted';
                });
                
                if (recentOrders.length > 0) {
                    const lastNotified = localStorage.getItem('lastAdminNotification');
                    const newOrders = recentOrders.filter(order => 
                        !lastNotified || new Date(order.timestamp) > new Date(lastNotified)
                    );
                    
                    newOrders.forEach(order => {
                        showNotification(`New order received: ${order.order_id}`, 'info');
                    });
                    
                    if (newOrders.length > 0) {
                        localStorage.setItem('lastAdminNotification', new Date().toISOString());
                        loadDashboardStats();
                        loadOrders();
                    }
                }
            }, 30000);
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }
        
        // Form submission handler
        document.getElementById('menuItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('editItemId').value;
            const itemData = {
                item_name: document.getElementById('itemName').value.trim(),
                price: parseFloat(document.getElementById('itemPrice').value),
                category: document.getElementById('itemCategory').value,
                availability: true
            };
            
            let result;
            if (itemId) {
                // Edit existing item
                result = await updateMenuItem(parseInt(itemId), itemData);
            } else {
                // Add new item
                result = await addMenuItem(itemData);
            }
            
            if (result.success) {
                showNotification(itemId ? 'Menu item updated successfully' : 'Menu item added successfully', 'success');
                cancelItemForm();
                loadMenuItems();
                loadDashboardStats();
            } else {
                showNotification(result.message, 'error');
            }
        });
        
        // Order verification function
        async function verifyOrder() {
            const orderId = document.getElementById('verifyOrderId').value.trim().toUpperCase();
            const resultDiv = document.getElementById('verificationResult');
            
            if (!orderId) {
                resultDiv.className = 'verification-result error';
                resultDiv.innerHTML = '<p>⚠️ Please enter an Order ID</p>';
                resultDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const orders = await getAllOrders();
                const order = orders.find(o => o.order_id === orderId);
                
                if (!order) {
                    resultDiv.className = 'verification-result error';
                    resultDiv.innerHTML = '<p>❌ Order not found</p>';
                    resultDiv.classList.remove('hidden');
                    return;
                }
                
                // Show order details
                let statusClass = 'info';
                let statusIcon = '⏳';
                let statusMessage = '';
                
                if (order.status === 'Completed') {
                    statusClass = 'success';
                    statusIcon = '✅';
                    statusMessage = 'Already picked up';
                } else if (order.status === 'Ready') {
                    statusClass = 'success';
                    statusIcon = '✅';
                    statusMessage = 'Ready for pickup';
                } else {
                    statusClass = 'warning';
                    statusIcon = '⏳';
                    statusMessage = 'Still being prepared';
                }
                
                resultDiv.className = `verification-result ${statusClass}`;
                resultDiv.innerHTML = `
                    <div class="verify-header">
                        <h4>${statusIcon} Order ${orderId}</h4>
                        <span class="verify-status">${statusMessage}</span>
                    </div>
                    <div class="verify-details">
                        <p><strong>Customer:</strong> ${order.username || 'Unknown'}</p>
                        <p><strong>Items:</strong> ${order.items.map(item => `${item.name} (x${item.quantity})`).join(', ')}</p>
                        <p><strong>Total:</strong> ₹${parseFloat(order.total_amount).toFixed(2)}</p>
                        <p><strong>Payment:</strong> ${order.payment_method}</p>
                        <p><strong>Time:</strong> ${new Date(order.created_at || order.timestamp).toLocaleString()}</p>
                    </div>
                    ${order.status === 'Ready' ? 
                        `<button onclick="markAsCompleted('${orderId}')" class="btn btn-primary" style="margin-top: 15px;">Mark as Collected</button>` : 
                        ''}
                `;
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error verifying order:', error);
                resultDiv.className = 'verification-result error';
                resultDiv.innerHTML = '<p>❌ Error verifying order. Please try again.</p>';
                resultDiv.classList.remove('hidden');
            }
        }
        
        // Mark order as completed
        async function markAsCompleted(orderId) {
            try {
                await updateOrderStatus(orderId, 'Completed');
                showNotification('Order marked as collected!', 'success');
                document.getElementById('verifyOrderId').value = '';
                document.getElementById('verificationResult').classList.add('hidden');
                loadOrders();
                loadDashboardStats();
            } catch (error) {
                console.error('Error marking order as completed:', error);
                showNotification('Failed to update order', 'error');
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('orderDetailsModal');
            if (event.target === modal) {
                closeOrderDetailsModal();
            }
        }
    </script>
</body>
</html>
